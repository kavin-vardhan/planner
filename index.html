<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saily & Kavin's Awesome Honeymoon</title>
  <style>
    :root {
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#06b6d4;
      --muted:#94a3b8;
    }
    html,body {
      height:100%;
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      color:#e6eef6;
      background:linear-gradient(180deg,#071022 0%, #071827 100%);
    }
    body {
      display:flex;
      flex-direction:column;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 24px;
      background:rgba(255,255,255,0.04);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    header h1 {
      font-size:20px;
      margin:0;
      color:var(--accent);
      letter-spacing:0.5px;
    }
    .app {
      display:flex;
      flex:1;
      min-height:0;
      gap:12px;
      padding:14px;
    }
    .sidebar {
      width:340px;
      background:rgba(255,255,255,0.03);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
    }
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    h2 { font-size:16px; margin:0; }
    button.add {
      background:var(--accent);
      border:none;
      color:#062026;
      padding:8px 12px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
    }
    .list { overflow:auto; flex:1; padding-right:6px; }
    .hotel {
      padding:10px;
      border-radius:8px;
      margin-bottom:8px;
      cursor:pointer;
      background:transparent;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .hotel.selected {
      background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));
      box-shadow:inset 0 0 0 1px rgba(6,182,212,0.06);
    }
    .hotel .meta { display:flex; flex-direction:column; }
    .hotel .name { font-weight:700; }
    .hotel .sub { color:var(--muted); font-size:12px; }
    .controls { display:flex; gap:6px; }
    .small {
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      padding:6px;
      border-radius:6px;
      color:var(--muted);
      cursor:pointer;
    }
    .mapWrap {
      flex:1;
      min-width:0;
      background:rgba(255,255,255,0.02);
      border-radius:12px;
      padding:8px;
      display:flex;
      flex-direction:column;
    }
    .mapHeader {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 10px;
    }
    .mapContainer {
      flex:1;
      border-radius:10px;
      overflow:hidden;
      background:#111;
    }
    iframe {
      border:0;
      width:100%;
      height:100%;
    }
    .modalBg {
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.6);
      display:none;
      align-items:center;
      justify-content:center;
    }
    .modal {
      background:#071428;
      padding:18px;
      border-radius:12px;
      width:420px;
      box-shadow:0 10px 30px rgba(2,6,23,0.7);
    }
    .modal label {
      display:block;
      font-size:13px;
      margin-bottom:6px;
    }
    .modal input {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:transparent;
      color:inherit;
      margin-bottom:12px;
    }
    .modal .row { display:flex; gap:8px; }
    .modal .row button { flex:1; }
    .empty { color:var(--muted); text-align:center; padding:20px; }

    /* right panel for itinerary */
    .itinerary {
      width:260px;
      background:rgba(255,255,255,0.03);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
    }
    .itinerary h3 {
      font-size:16px;
      margin-top:0;
      margin-bottom:10px;
      color:var(--accent);
    }
    .night {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      padding:6px 8px;
    }
    .night label { font-size:13px; }
    select {
      background:#0b1220;
      color:#e6eef6;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      padding:4px;
    }

    @media(max-width:1000px){
      .app { flex-direction:column; }
      .sidebar, .itinerary { width:100%; order:2; }
      .mapWrap { order:1; height:60vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Saily & Kavin's Awesome Honeymoon</h1>
  </header>

  <div class="app">
    <div class="sidebar" role="navigation">
      <div class="header">
        <h2>Hotels</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="small" id="clearStorage" title="Clear saved hotels">Clear</button>
          <button class="add" id="addBtn">+ Add New Hotel</button>
        </div>
      </div>
      <div class="list" id="hotelList" aria-live="polite">
        <div class="empty" id="emptyMsg">No hotels yet — click “Add New Hotel” to create one.</div>
      </div>
    </div>

    <div class="mapWrap">
      <div class="mapHeader">
        <div>
          <strong id="selectedName">No hotel selected</strong>
          <div style="font-size:12px;color:var(--muted)" id="selectedLink">—</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="small" id="zoomBtn">Zoom to place</button>
          <button class="small" id="openBtn">Open in Google Maps</button>
        </div>
      </div>
      <div class="mapContainer">
        <iframe id="mapFrame" src="https://www.google.com/maps?q=thailand&output=embed" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>

    <div class="itinerary">
      <h3>Night Stay Details</h3>
      <div id="nightsContainer"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal" role="dialog" aria-modal="true">
      <h2 style="margin-top:0;margin-bottom:8px">Add new hotel</h2>
      <label for="hotelName">Hotel name</label>
      <input id="hotelName" placeholder="Example: The Grand Plaza" />
      <label for="hotelLink">Google Maps link or coordinates</label>
      <input id="hotelLink" placeholder="Paste Google Maps share link, place name or `lat,lng`" />
      <div class="row">
        <button id="saveBtn" class="add">Save</button>
        <button id="cancelBtn" class="small">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /* -------------------------
       Local app state & helpers
       ------------------------- */
    const addBtn = document.getElementById('addBtn');
    const modalBg = document.getElementById('modalBg');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const hotelListEl = document.getElementById('hotelList');
    const emptyMsg = document.getElementById('emptyMsg');
    const nameInput = document.getElementById('hotelName');
    const linkInput = document.getElementById('hotelLink');
    const mapFrame = document.getElementById('mapFrame');
    const selectedName = document.getElementById('selectedName');
    const selectedLink = document.getElementById('selectedLink');
    const zoomBtn = document.getElementById('zoomBtn');
    const openBtn = document.getElementById('openBtn');
    const clearStorage = document.getElementById('clearStorage');
    const nightsContainer = document.getElementById('nightsContainer');

    // local storage keys
    const hotelsKey = 'hotels_v1';
    const selectedKey = 'hotels_selected';
    const itineraryKey = 'honeymoon_itinerary_v1';

    // local state (selection stays local)
    let hotels = JSON.parse(localStorage.getItem(hotelsKey) || '[]');
    let selectedIndex = parseInt(localStorage.getItem(selectedKey)) || 0;
    let itinerary = JSON.parse(localStorage.getItem(itineraryKey) || '[]');
    if(!Array.isArray(itinerary) || itinerary.length !== 8) itinerary = Array.from({length:8},()=>'');

    // destination options
    const destinations = ['Phuket','Phi Phi','Krabi','Khao Sok','Bangkok'];
    const startDate = new Date(2026,1,21); // Feb 21, 2026

    /* -------------------------
       Rendering functions
       ------------------------- */
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function renderList(){
      hotelListEl.innerHTML = '';
      if(!hotels.length){
        hotelListEl.appendChild(emptyMsg);
        return;
      }
      hotels.forEach((h, i) => {
        const el = document.createElement('div');
        el.className = 'hotel' + (i===selectedIndex? ' selected':'');
        el.tabIndex = 0;
        el.innerHTML = `<div class="meta"><div class="name">${escapeHtml(h.name)}</div><div class="sub">${escapeHtml(h.link)}</div></div>`;
        const controls = document.createElement('div');
        controls.className = 'controls';
        const edit = document.createElement('button'); edit.className='small'; edit.title='Edit'; edit.innerText='Edit';
        const del = document.createElement('button'); del.className='small'; del.title='Delete'; del.innerText='Delete';
        controls.appendChild(edit); controls.appendChild(del);
        el.appendChild(controls);

        el.addEventListener('click', (ev)=>{
          if(ev.target===del || ev.target===edit) return; // allow button handlers
          selectedIndex = i; localSaveSelection(); renderList(); updateMap();
        });
        el.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter') { selectedIndex = i; localSaveSelection(); renderList(); updateMap(); }});

        edit.addEventListener('click',(ev)=>{ ev.stopPropagation(); openModal(h.name,h.link,i); });
        del.addEventListener('click',(ev)=>{ ev.stopPropagation(); if(confirm('Delete "'+h.name+'"?')){ hotels.splice(i,1); if(selectedIndex>=hotels.length) selectedIndex = hotels.length-1; localSaveAll(); saveHotelData().catch(e=>console.warn('saveHotelData error',e)); renderList(); updateMap(); }});

        hotelListEl.appendChild(el);
      });
    }

    function updateMap(){
      if(!hotels.length || selectedIndex<0 || selectedIndex>=hotels.length){
        selectedName.textContent='No hotel selected';
        selectedLink.textContent='—';
        mapFrame.src = 'https://www.google.com/maps?q=thailand&output=embed';
        return;
      }
      const h = hotels[selectedIndex];
      selectedName.textContent = h.name;
      selectedLink.textContent = h.link || '—';
      const embed = buildEmbedUrl(h.link || h.name);
      mapFrame.src = embed;
    }

    function buildEmbedUrl(raw){
      if(!raw) return 'https://www.google.com/maps?q=thailand&output=embed';
      raw = raw.trim();
      const coord = raw.match(/@?\s*([+-]?\d+\.\d+)\s*,\s*([+-]?\d+\.\d+)/);
      if(coord){ const q = coord[1]+','+coord[2]; return 'https://www.google.com/maps?q='+encodeURIComponent(q)+'&output=embed'; }
      const at = raw.match(/@([+-]?\d+\.\d+),([+-]?\d+\.\d+),/);
      if(at){ const q = at[1]+','+at[2]; return 'https://www.google.com/maps?q='+encodeURIComponent(q)+'&output=embed'; }
      if(raw.includes('/maps/embed') || raw.includes('maps.google.com/maps')){
        return raw.includes('output=') ? raw : (raw + (raw.includes('?')? '&output=embed' : '?output=embed'));
      }
      if(raw.startsWith('http')){
        try{ const url = new URL(raw); if(url.hostname.includes('google')){ const q = url.searchParams.get('q') || url.pathname; return 'https://www.google.com/maps?q='+encodeURIComponent(q)+'&output=embed'; } }catch(e){}
      }
      return 'https://www.google.com/maps?q='+encodeURIComponent(raw)+'&output=embed';
    }

    /* -------------------------
       Modal & create/edit hotel
       ------------------------- */
    function openModal(name='', link='', editIndex=null){
      nameInput.value = name || '';
      linkInput.value = link || '';
      modalBg.style.display = 'flex';
      nameInput.focus();
      saveBtn.onclick = ()=>{
        const n = nameInput.value.trim(); const l = linkInput.value.trim();
        if(!n){ alert('Please enter a hotel name'); nameInput.focus(); return; }
        if(editIndex===null){ hotels.push({name:n, link:l}); selectedIndex = hotels.length-1; }
        else { hotels[editIndex] = {name:n, link:l}; selectedIndex = editIndex; }
        localSaveAll();
        saveHotelData().catch(e=>console.warn('saveHotelData error', e));
        renderList(); updateMap(); closeModal();
      };
    }
    function closeModal(){ modalBg.style.display='none'; }
    cancelBtn.onclick = closeModal;
    modalBg.addEventListener('click', (e)=>{ if(e.target===modalBg) closeModal(); });
    addBtn.addEventListener('click', ()=> openModal());

    /* -------------------------
       Local persistence helpers
       ------------------------- */
    function localSaveAll(){
      localStorage.setItem(hotelsKey, JSON.stringify(hotels));
      localStorage.setItem(selectedKey, selectedIndex);
      localStorage.setItem(itineraryKey, JSON.stringify(itinerary));
    }
    function localSaveSelection(){
      localStorage.setItem(selectedKey, selectedIndex);
    }

    /* -------------------------
       Itinerary rendering & handlers
       ------------------------- */
    function renderItinerary(){
      nightsContainer.innerHTML = '';
      for(let i=0;i<8;i++){
        const nightDate = new Date(startDate);
        nightDate.setDate(startDate.getDate()+i);
        const div = document.createElement('div');
        div.className='night';
        const sel = document.createElement('select');
        sel.innerHTML = `<option value="">—</option>` + destinations.map(d=>`<option value="${d}" ${itinerary[i]===d?'selected':''}>${d}</option>`).join('');
        sel.onchange = async ()=>{ itinerary[i] = sel.value; localSaveAll(); try{ await saveItineraryData(); }catch(e){ console.warn('saveItineraryData error',e); } };
        div.innerHTML = `<label>Feb ${21+i}</label>`;
        div.appendChild(sel);
        nightsContainer.appendChild(div);
      }
    }

    /* -------------------------
       FIRESTORE integration
       ------------------------- */
  </script>

  <!-- Firebase SDK (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ----- paste / confirm your firebase config here -----
    const firebaseConfig = {
      apiKey: "AIzaSyBS5earknRLZQWj9kn0qhJFgMfD8EgNY_0",
      authDomain: "planner-21feb.firebaseapp.com",
      projectId: "planner-21feb",
      storageBucket: "planner-21feb.firebasestorage.app",
      messagingSenderId: "552796038598",
      appId: "1:552796038598:web:67538b22c836890c257ec7"
    };
    // ----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("Firebase initialized for project:", firebaseConfig.projectId);

    // Firestore collection refs
    const hotelsCol = collection(db, "hotels");
    const itineraryCol = collection(db, "itinerary");

    // Helper: write all hotels (indexed docs 0,1,2...)
    async function saveHotelData(){
      try{
        // set each hotel as doc "0", "1", ...
        for(let i=0;i<hotels.length;i++){
          await setDoc(doc(db, "hotels", i.toString()), hotels[i]);
        }
        // delete extra documents if they exist on server beyond current length
        const serverDocs = await getDocs(hotelsCol);
        const serverIds = serverDocs.docs.map(d=>d.id);
        for(const id of serverIds){
          const idx = parseInt(id,10);
          if(!Number.isNaN(idx) && idx >= hotels.length){
            await deleteDoc(doc(db,"hotels", id));
          }
        }
      }catch(e){
        console.warn("saveHotelData failed:",e);
        throw e;
      }
    }

    // Helper: write itinerary (docs 0..7 with {place})
    async function saveItineraryData(){
      try{
        for(let i=0;i<itinerary.length;i++){
          await setDoc(doc(db,"itinerary", i.toString()), { place: itinerary[i] || "" });
        }
        // cleanup extra docs
        const serverDocs = await getDocs(itineraryCol);
        const serverIds = serverDocs.docs.map(d=>d.id);
        for(const id of serverIds){
          const idx = parseInt(id,10);
          if(!Number.isNaN(idx) && idx >= itinerary.length){
            await deleteDoc(doc(db,"itinerary", id));
          }
        }
      }catch(e){
        console.warn("saveItineraryData failed:",e);
        throw e;
      }
    }

    // Read live updates from Firestore and merge into local
    const unsubscribeHotels = onSnapshot(hotelsCol, (snapshot) => {
      try{
        // Build array sorted by numeric id
        const docs = snapshot.docs
          .filter(d => !isNaN(Number(d.id)))
          .map(d => ({ id: Number(d.id), data: d.data() }))
          .sort((a,b)=>a.id-b.id)
          .map(x=>x.data);

        // If server-side list differs from local, update local array and persist locally
        const serverJson = JSON.stringify(docs || []);
        const localJson = JSON.stringify(hotels || []);
        if(serverJson !== localJson){
          hotels = docs || [];
          localSaveAll();
          // Only update UI list/iframe selection if selection index still valid
          if(selectedIndex >= hotels.length) selectedIndex = Math.max(0, hotels.length-1);
          renderList();
          updateMap();
        }
      }catch(e){
        console.warn("onSnapshot hotels processing error:",e);
      }
    }, (err)=> {
      console.warn("onSnapshot hotels error:", err);
    });

    const unsubscribeItinerary = onSnapshot(itineraryCol, (snapshot) => {
      try{
        // Build array sorted by numeric id
        const docs = snapshot.docs
          .filter(d => !isNaN(Number(d.id)))
          .map(d => ({ id: Number(d.id), data: d.data() }))
          .sort((a,b)=>a.id-b.id)
          .map(x => (x.data && typeof x.data.place !== 'undefined') ? x.data.place : '');

        const serverJson = JSON.stringify(docs || []);
        const localJson = JSON.stringify(itinerary || []);
        if(serverJson !== localJson){
          itinerary = docs.length ? docs : Array.from({length:8},()=> '');
          localSaveAll();
          renderItinerary();
        }
      }catch(e){
        console.warn("onSnapshot itinerary processing error:",e);
      }
    }, (err) => {
      console.warn("onSnapshot itinerary error:", err);
    });

    // Expose save functions to global for use in the main script
    window.saveHotelData = saveHotelData;
    window.saveItineraryData = saveItineraryData;

  </script>

  <script>
    /* -------------------------
       Hook up remaining UI pieces
       ------------------------- */

    // wire up clear
    clearStorage.addEventListener('click', ()=>{
      if(confirm('Clear saved hotels and itinerary locally? (This will also clear synced data when connection active)')){
        hotels = [];
        itinerary = Array.from({length:8},()=> '');
        selectedIndex = 0;
        localSaveAll();
        // try to remove server docs too
        if(window.saveHotelData && window.saveItineraryData){
          // save empty arrays to server (which will remove extra docs)
          saveHotelData().catch(e=>console.warn(e));
          saveItineraryData().catch(e=>console.warn(e));
        }
        renderList(); updateMap(); renderItinerary();
      }
    });

    // zoom / open
    zoomBtn.addEventListener('click', ()=>{ updateMap(); mapFrame.focus(); });
    openBtn.addEventListener('click', ()=>{
      if(!hotels.length) return; const h = hotels[selectedIndex];
      const url = buildOpenUrl(h.link||h.name);
      window.open(url,'_blank');
    });
    function buildOpenUrl(raw){
      if(!raw) return 'https://www.google.com/maps';
      const at = raw.match(/@([+-]?\d+\.\d+),([+-]?\d+\.\d+),/);
      if(at) return 'https://www.google.com/maps?q='+encodeURIComponent(at[1]+','+at[2]);
      if(raw.startsWith('http')) return raw;
      return 'https://www.google.com/maps?q='+encodeURIComponent(raw);
    }

    // initial render calls
    renderList();
    updateMap();
    renderItinerary();

    // attempt to sync initial local state to Firestore once SDK loaded
    // (this will create server docs if they don't exist yet)
    (async ()=>{
      // give the firebase script a tiny moment to initialize
      await new Promise(r => setTimeout(r, 250));
      if(window.saveHotelData){
        try{ await saveHotelData(); }catch(e){ console.warn('initial saveHotelData failed',e); }
      }
      if(window.saveItineraryData){
        try{ await saveItineraryData(); }catch(e){ console.warn('initial saveItineraryData failed',e); }
      }
    })();

  </script>
</body>
</html>
