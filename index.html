<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saily & Kavin's Awesome Honeymoon</title>
  <style>
    :root {
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#06b6d4;
      --muted:#94a3b8;

      /* tag color palette */
      --phuket:#f97316;
      --phiphi:#06b6d4;
      --krabi:#22c55e;
      --khaosok:#eab308;
      --bangkok:#a855f7;
    }

    html,body {
      height:100%;
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      color:#e6eef6;
      background:linear-gradient(180deg,#071022 0%, #071827 100%);
    }
    body { display:flex; flex-direction:column; }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 24px;
      background:rgba(255,255,255,0.04);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    header h1 {
      font-size:20px;
      margin:0;
      color:var(--accent);
      letter-spacing:0.5px;
    }

    .app {
      display:flex;
      flex:1;
      min-height:0;
      gap:12px;
      padding:14px;
    }

    .sidebar {
      width:340px;
      background:rgba(255,255,255,0.03);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
    }

    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }

    h2 { font-size:16px; margin:0; }

    button.add {
      background:var(--accent);
      border:none;
      color:#062026;
      padding:8px 12px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
    }

    .list { overflow:auto; flex:1; padding-right:6px; }

    .hotel {
      padding:10px;
      border-radius:8px;
      margin-bottom:8px;
      cursor:pointer;
      background:transparent;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .hotel.selected {
      background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));
      box-shadow:inset 0 0 0 1px rgba(6,182,212,0.06);
    }

    .hotel .meta {
      display:flex;
      flex-direction:column;
      flex:1;
    }

    .hotel .name { font-weight:700; }

    .tag {
      display:inline-block;
      margin-top:4px;
      padding:2px 6px;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      color:#000;
      width:max-content;
    }

    .controls {
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .small {
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      padding:6px 8px;
      border-radius:6px;
      color:var(--muted);
      cursor:pointer;
      font-size:12px;
      text-align:center;
    }

    .small.disabled {
      opacity:0.4;
      cursor:not-allowed;
    }

    .mapWrap {
      flex:1;
      min-width:0;
      background:rgba(255,255,255,0.02);
      border-radius:12px;
      padding:8px;
      display:flex;
      flex-direction:column;
    }

    .mapHeader {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 10px;
    }

    .mapContainer {
      flex:1;
      border-radius:10px;
      overflow:hidden;
      background:#111;
    }

    iframe {
      border:0;
      width:100%;
      height:100%;
    }

    .modalBg {
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.6);
      display:none;
      align-items:center;
      justify-content:center;
    }

    .modal {
      background:#071428;
      padding:18px;
      border-radius:12px;
      width:420px;
      box-shadow:0 10px 30px rgba(2,6,23,0.7);
    }

    .modal label {
      display:block;
      font-size:13px;
      margin-bottom:6px;
    }

    .modal input, .modal select {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:transparent;
      color:inherit;
      margin-bottom:12px;
    }

    .modal .row { display:flex; gap:8px; }
    .modal .row button { flex:1; }

    .empty { color:var(--muted); text-align:center; padding:20px; }

    .itinerary {
      width:260px;
      background:rgba(255,255,255,0.03);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
    }

    .itinerary h3 {
      font-size:16px;
      margin-top:0;
      margin-bottom:10px;
      color:var(--accent);
    }

    .night {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      padding:6px 8px;
    }

    .night label { font-size:13px; }

    select {
      background:#0b1220;
      color:#e6eef6;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      padding:4px;
    }

    @media(max-width:1000px){
      .app { flex-direction:column; }
      .sidebar, .itinerary { width:100%; order:2; }
      .mapWrap { order:1; height:60vh; }
    }
  </style>
</head>

<body>
<header>
  <h1>Saily & Kavin's Awesome Honeymoon</h1>
</header>

<div class="app">

  <!-- ---------------- Sidebar (Hotels) ---------------- -->
  <div class="sidebar">
    <div class="header">
      <h2>Hotels</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="small" id="clearStorage">Clear</button>
        <button class="add" id="addBtn">+ Add New Hotel</button>
      </div>
    </div>

    <div class="list" id="hotelList">
      <div class="empty" id="emptyMsg">No hotels yet — click “Add New Hotel” to create one.</div>
    </div>
  </div>

  <!-- ---------------- Map ---------------- -->
  <div class="mapWrap">
    <div class="mapHeader">
      <div>
        <strong id="selectedName">No hotel selected</strong>
        <div style="font-size:12px;color:var(--muted)" id="selectedLink">—</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="small" id="zoomBtn">Zoom</button>
        <button class="small" id="openBtn">Open Maps</button>
      </div>
    </div>

    <div class="mapContainer">
      <iframe id="mapFrame" src="https://www.google.com/maps?q=thailand&output=embed"></iframe>
    </div>
  </div>

  <!-- ---------------- Itinerary ---------------- -->
  <div class="itinerary">
    <h3>Night Stay Details</h3>
    <div id="nightsContainer"></div>
  </div>

</div>

<!-- ---------------- Modal ---------------- -->
<div class="modalBg" id="modalBg">
  <div class="modal">
    <h2 style="margin-top:0;margin-bottom:8px">Add new hotel</h2>

    <label>Hotel name</label>
    <input id="hotelName">

    <label>Google Maps link</label>
    <input id="hotelLink">

    <label>Booking link (optional)</label>
    <input id="hotelBooking">

    <label>Location</label>
    <select id="hotelLocation">
      <option value="">—</option>
      <option>Phuket</option>
      <option>Phi Phi</option>
      <option>Krabi</option>
      <option>Khao Sok</option>
      <option>Bangkok</option>
    </select>

    <div class="row">
      <button class="add" id="saveBtn">Save</button>
      <button class="small" id="cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- MAIN APP LOGIC (Local + UI)  -->
<!-- ============================= -->
<script>
/* ------ UI Elements ------ */
const addBtn = document.getElementById('addBtn');
const modalBg = document.getElementById('modalBg');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');

const nameInput = document.getElementById('hotelName');
const linkInput = document.getElementById('hotelLink');
const bookingInput = document.getElementById('hotelBooking');
const locationInput = document.getElementById('hotelLocation');

const hotelListEl = document.getElementById('hotelList');
const emptyMsg = document.getElementById('emptyMsg');

const nightsContainer = document.getElementById('nightsContainer');

const selectedName = document.getElementById('selectedName');
const selectedLink = document.getElementById('selectedLink');
const mapFrame = document.getElementById('mapFrame');

const clearStorage = document.getElementById('clearStorage');
const zoomBtn = document.getElementById('zoomBtn');
const openBtn = document.getElementById('openBtn');

/* ------ Local State ------ */
const hotelsKey = 'hotels_v1';
const selectedKey = 'hotels_selected';
const itineraryKey = 'honeymoon_itinerary_v1';

let hotels = JSON.parse(localStorage.getItem(hotelsKey) || '[]');
let selectedIndex = parseInt(localStorage.getItem(selectedKey) || '0');
let itinerary = JSON.parse(localStorage.getItem(itineraryKey) || '[]');
if (!Array.isArray(itinerary) || itinerary.length !== 8)
  itinerary = Array.from({length:8},()=>'');

/* ------ Helpers ------ */
function escapeHtml(s){ return String(s||'').replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

function localSaveAll(){
  localStorage.setItem(hotelsKey, JSON.stringify(hotels));
  localStorage.setItem(selectedKey, selectedIndex);
  localStorage.setItem(itineraryKey, JSON.stringify(itinerary));
}

function localSaveSelection(){
  localStorage.setItem(selectedKey, selectedIndex);
}

/* ------ Render Hotel List ------ */
function renderList(){
  hotelListEl.innerHTML = '';
  if(!hotels.length){
    hotelListEl.appendChild(emptyMsg);
    return;
  }

  hotels.forEach((h,i)=>{
    const el = document.createElement('div');
    el.className = 'hotel' + (i===selectedIndex ? ' selected' : '');

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `
      <div class="name">${escapeHtml(h.name)}</div>
      <span class="tag" style="background:${
        h.location==='Phuket'   ? 'var(--phuket)'   :
        h.location==='Phi Phi'  ? 'var(--phiphi)'   :
        h.location==='Krabi'    ? 'var(--krabi)'    :
        h.location==='Khao Sok' ? 'var(--khaosok)'  :
        h.location==='Bangkok'  ? 'var(--bangkok)'  :
        '#999'
      }">${h.location || ''}</span>
      <div class="sub">${escapeHtml(h.link || '')}</div>
    `;

    const controls = document.createElement('div');
    controls.className = 'controls';

    const goBtn = document.createElement('button');
    goBtn.className = 'small';
    goBtn.innerText = 'Go';
    if(h.booking){
      goBtn.onclick = e => { e.stopPropagation(); window.open(h.booking,'_blank'); };
    } else {
      goBtn.classList.add('disabled');
    }

    const editBtn = document.createElement('button');
    editBtn.className = 'small';
    editBtn.innerText = 'Edit';
    editBtn.onclick = e => {
      e.stopPropagation();
      openModal(h.name,h.link,i,h.booking,h.location);
    };

    const delBtn = document.createElement('button');
    delBtn.className = 'small';
    delBtn.innerText = 'Delete';
    delBtn.onclick = e => {
      e.stopPropagation();
      if(confirm(`Delete "${h.name}"?`)){
        hotels.splice(i,1);
        if(selectedIndex>=hotels.length) selectedIndex = hotels.length-1;
        localSaveAll();
        saveHotelData().catch(()=>{});
        renderList();
        updateMap();
      }
    };

    controls.appendChild(goBtn);
    controls.appendChild(editBtn);
    controls.appendChild(delBtn);

    el.appendChild(meta);
    el.appendChild(controls);

    el.onclick = ()=>{
      selectedIndex = i;
      localSaveSelection();
      renderList();
      updateMap();
    };

    hotelListEl.appendChild(el);
  });
}

/* ------ Modal / Add / Edit ------ */
function openModal(name='', link='', index=null, booking='', location=''){
  nameInput.value = name;
  linkInput.value = link;
  bookingInput.value = booking || '';
  locationInput.value = location || '';

  modalBg.style.display='flex';
  nameInput.focus();

  saveBtn.onclick = ()=>{
    const n = nameInput.value.trim();
    if(!n){ alert('Name required'); return; }

    const entry = {
      name:n,
      link:linkInput.value.trim(),
      booking:bookingInput.value.trim(),
      location:locationInput.value || ''
    };

    if(index===null){
      hotels.push(entry);
      selectedIndex = hotels.length-1;
    } else {
      hotels[index] = entry;
      selectedIndex = index;
    }

    localSaveAll();
    saveHotelData().catch(()=>{});
    renderList();
    updateMap();
    closeModal();
  };
}

function closeModal(){ modalBg.style.display='none'; }
cancelBtn.onclick = closeModal;
modalBg.onclick = e=>{ if(e.target===modalBg) closeModal(); };
addBtn.onclick = ()=> openModal();

/* ------ Map ------ */
function buildEmbedUrl(raw){
  if(!raw) return "https://www.google.com/maps?q=thailand&output=embed";
  raw=raw.trim();
  const coords = raw.match(/@?([0-9.+-]+),([0-9.+-]+)/);
  if(coords){
    const q = coords[1]+','+coords[2];
    return 'https://www.google.com/maps?q='+encodeURIComponent(q)+'&output=embed';
  }
  return 'https://www.google.com/maps?q='+encodeURIComponent(raw)+'&output=embed';
}

function updateMap(){
  if(!hotels.length || selectedIndex<0 || selectedIndex>=hotels.length){
    selectedName.innerText='No hotel selected';
    selectedLink.innerText='—';
    mapFrame.src='https://www.google.com/maps?q=thailand&output=embed';
    return;
  }

  const h = hotels[selectedIndex];
  selectedName.innerText=h.name;
  selectedLink.innerText=h.link||'—';
  mapFrame.src = buildEmbedUrl(h.link||h.name);
}

zoomBtn.onclick = ()=> mapFrame.focus();
openBtn.onclick = ()=>{
  if(!hotels.length) return;
  const h = hotels[selectedIndex];
  window.open(h.link || "", '_blank');
};

/* ------ Itinerary ------ */
const startDate = new Date(2026,1,21);
const locations = ['Phuket','Phi Phi','Krabi','Khao Sok','Bangkok'];

function renderItinerary(){
  nightsContainer.innerHTML='';
  for(let i=0;i<8;i++){
    const row = document.createElement('div');
    row.className='night';

    const label = document.createElement('label');
    label.innerText = `Feb ${21+i}`;

    const sel = document.createElement('select');
    sel.innerHTML = `<option value="">—</option>` + 
      locations.map(loc=>`<option ${itinerary[i]===loc?'selected':''}>${loc}</option>`).join('');

    sel.onchange = async ()=>{
      itinerary[i]=sel.value;
      localSaveAll();
      await saveItineraryData();
    };

    row.appendChild(label);
    row.appendChild(sel);
    nightsContainer.appendChild(row);
  }
}

/* ------ Clear All ------ */
clearStorage.onclick = ()=>{
  if(confirm("Clear everything?")) {
    hotels=[];
    itinerary=Array.from({length:8},()=> '');
    selectedIndex=0;
    localSaveAll();
    saveHotelData().catch(()=>{});
    saveItineraryData().catch(()=>{});
    renderList();
    renderItinerary();
    updateMap();
  }
};

/* ------ Initial Render ------ */
renderList();
renderItinerary();
updateMap();

</script>

<!-- ============================= -->
<!-- FIREBASE SYNC (Firestore)     -->
<!-- ============================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDocs,
  setDoc, deleteDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBS5earknRLZQWj9kn0qhJFgMfD8EgNY_0",
  authDomain: "planner-21feb.firebaseapp.com",
  projectId: "planner-21feb",
  storageBucket: "planner-21feb.firebasestorage.app",
  messagingSenderId: "552796038598",
  appId: "1:552796038598:web:67538b22c836890c257ec7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const hotelsCol = collection(db,"hotels");
const itineraryCol = collection(db,"itinerary");

/* ------- Save Hotels to Firestore ------- */
async function saveHotelData(){
  try{
    for(let i=0;i<hotels.length;i++){
      await setDoc(doc(db,"hotels",String(i)), hotels[i]);
    }
    const snap = await getDocs(hotelsCol);
    const ids = snap.docs.map(d=>d.id);
    for(const id of ids){
      const idx = Number(id);
      if(idx>=hotels.length)
        await deleteDoc(doc(db,"hotels",id));
    }
  }catch(e){ console.warn("saveHotelData error",e); }
}

/* ------- Save Itinerary to Firestore ------- */
async function saveItineraryData(){
  try{
    for(let i=0;i<itinerary.length;i++){
      await setDoc(doc(db,"itinerary",String(i)), { place: itinerary[i]||"" });
    }
    const snap = await getDocs(itineraryCol);
    const ids = snap.docs.map(d=>d.id);
    for(const id of ids){
      const idx = Number(id);
      if(idx>=itinerary.length)
        await deleteDoc(doc(db,"itinerary",id));
    }
  }catch(e){ console.warn("saveItineraryData error",e); }
}

/* ------- Live Sync Hotels ------- */
onSnapshot(hotelsCol, snap=>{
  try{
    const arr = snap.docs
      .filter(d=>!isNaN(Number(d.id)))
      .map(d=>({id:Number(d.id), data:d.data()}))
      .sort((a,b)=>a.id-b.id)
      .map(x=>x.data);

    const remote = JSON.stringify(arr);
    const local = JSON.stringify(hotels);

    if(remote!==local){
      hotels = arr;
      localSaveAll();
      if(selectedIndex>=hotels.length) selectedIndex=Math.max(0,hotels.length-1);
      renderList();
      updateMap();
    }
  }catch(e){ console.warn("snapshot hotel fail",e); }
});

/* ------- Live Sync Itinerary ------- */
onSnapshot(itineraryCol, snap=>{
  try{
    const arr = snap.docs
      .filter(d=>!isNaN(Number(d.id)))
      .map(d=>({id:Number(d.id), data:d.data()}))
      .sort((a,b)=>a.id-b.id)
      .map(x=>x.data.place||"");

    const remote = JSON.stringify(arr);
    const local = JSON.stringify(itinerary);

    if(remote!==local){
      itinerary = arr.length? arr : Array.from({length:8},()=> "");
      localSaveAll();
      renderItinerary();
    }
  }catch(e){ console.warn("snapshot itinerary fail",e); }
});

/* Initial push to Firestore (only if needed) */
setTimeout(()=>{
  saveHotelData();
  saveItineraryData();
},500);

/* make functions visible to main script */
window.saveHotelData = saveHotelData;
window.saveItineraryData = saveItineraryData;

</script>

</body>
</html>
